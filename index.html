<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard OBA</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" />
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background-color: #F5F7FA;
    color: #001F3F;
  }

  /* === Navbar Modern === */
  .navbar {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: linear-gradient(90deg, #1061b8, #a3ccf5);
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .navbar .links a {
  color: white;
  margin-right: 15px;
  text-decoration: none;
  cursor: pointer;        
  transition: color 0.2s;    
}

.navbar .links a:hover {
  color: #fee9a1;          
}

h3, h4 {
  margin-top: 8px;
  margin-bottom: 8px;
}

  .navbar .links a:hover {
    opacity: 0.8;
  }

  .navbar .links a.active {
    font-weight: 600;
    text-decoration: underline;
  }

  /* === Pages === */
  .page {
    display: none;
    padding: 10px 20px;
    margin-top: 65px;
  }

  .page.active {
    display: block;
  }

  /* === Buttons & Links === */
  .gform-link {
    position: fixed;
    top: 15px;
    right: 20px;
    background-color: #1d8e26;
    color: #fff;
    text-decoration: none;
    font-weight: 600;
    padding: 8px 14px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: 0.25s;
    z-index: 1000;
  }

  .gform-link:hover {
    background-color: #2774c5;
  }

  /* === Map === */
  #map {
    position: relative;
    height: 80vh;
    width: 100%;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  /* === Checkbox Group === */
  .checkbox-group {
    position: absolute;
    top: 100px;
    right: 20px;
    background: white;
    padding: 10px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 1001;
    font-size: 14px;
  }

  /* === Station Labels === */
  .station-label {
    font-size: 12px;
    font-weight: 500;
    color: #000;
    background: rgba(255,255,255,0.9);
    padding: 2px 6px;
    border-radius: 4px;
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  /* === Table === */
  table {
  border-collapse: collapse;
  width: 100%;
  font-size: 14px;
  table-layout: fixed; /* membantu rendering sticky lebih stabil */
}

thead th {
  position: sticky;
  top: 0;
  background: #1d8e26;
  color: white;
  z-index: 10;
}

  th, td {
    border: 1px solid #e0e0e0;
    padding: 8px;
    text-align: center;
  }


  table td:nth-child(3) {
    text-align: left;
    padding-left: 8px;
  }

  /* === Side Popup === */
  .info-side-popup {
    position: absolute;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.25);
    padding: 12px;
    font-size: 13px;
    width: 260px;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 10000;
    display: none;
    animation: slideIn 0.2s ease-out;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(10px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* === Legend === */
  .legend {
    background: white;
    padding: 8px 12px;
    font-size: 13px;
    line-height: 18px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  
</style>

</head>
<body>
  <div class="navbar">
    <div class="links">
      <a id="linkMap" class="active">üåç Peta</a> 
      <a id="linkData">üìä Tabel Data</a>
      <a href="https://forms.gle/KjUSwAp6DjGzHYE86" target="_blank" class="gform-link">üìù Update Data Stasiun</a>
    </div>
  </div>

  <div id="pageMap" class="page active">
    <h3>Sebaran Kondisi Peralatan Pengamatan Udara Atas UPT</h3>
    <div id="map"></div>
    <div id="infoSidePopup" class="info-side-popup"></div>
  </div>

  <div class="checkbox-group">
  <label><input type="checkbox" id="theodolite" checked> Theodolite </label><br>
  <label><input type="checkbox" id="tabung" checked> Tabung Gas </label><br>
  <label><input type="checkbox" id="ground" checked> Ground Equipment </label><br>
  <label><input type="checkbox" id="kop" checked> Kop gas </label>
  </div>

  <div id="pageData" class="page">
    <h3>Tabel Data Peralatan Observasi Udara Atas UPT</h3>
    <div style="max-height: 90vh; overflow-y: auto; overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>No</th><th>Stasiun</th>
            <th>Theodolite Baik</th><th>Theodolite Rusak Ringan</th><th>Theodolite Rusak Berat</th>
            <th>Kerusakan Theodolite</th><th>Kondisi Ground Equipment</th>
            <th>Tahun Pengadaan Ground Equipment</th><th>Kondisi Tabung Gas</th>
            <th>Kerusakan Tabung Gas</th><th>Tahun Pengadaan Tabung Gas</th>
            <th>Kondisi Kop Gas</th>Tahun Pengadaan Kop Gas</th><th>
            <th>Kendala Lainnya</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
  // === NAVIGATION ===
  const linkMap = document.getElementById("linkMap"),
        linkData = document.getElementById("linkData"),
        pageMap = document.getElementById("pageMap"),
        pageData = document.getElementById("pageData");

  function showPage(link, page) {
    [linkMap, linkData].forEach(l => l.classList.remove("active"));
    [pageMap, pageData].forEach(p => p.classList.remove("active"));
    link.classList.add("active");
    page.classList.add("active");
  }

  linkMap.onclick = () => showPage(linkMap, pageMap);
  linkData.onclick = () => showPage(linkData, pageData);
 

  // === kontrol visibilitas checkbox balai ===
function toggleCheckboxVisibility(show) {
  document.querySelectorAll(".checkbox-group").forEach(el => {
    el.style.display = show ? "block" : "none";
  });
}

// tampilkan hanya di page peta
linkMap.addEventListener("click", () => {
  toggleCheckboxVisibility(true);
});

linkData.addEventListener("click", () => {
  toggleCheckboxVisibility(false);
});


  // === MAP SETUP ===
  const map = L.map("map", {
    fullscreenControl: true,
    fullscreenControlOptions: { position: 'topleft' }
  }).setView([-2.5,118],5);

  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: '&copy; Esri, HERE, Garmin, FAO, NOAA, USGS'
  }).addTo(map);

  // === Layer per Alat ===
const alatLayers = {
  theodolite: L.layerGroup().addTo(map),
  tabung: L.layerGroup().addTo(map),
  ground: L.layerGroup().addTo(map),
  kop: L.layerGroup().addTo(map),
};

  
  // --- make popup & checkbox visible in fullscreen ---
// ambil elemen checkbox-group dan infoSidePopup
const checkboxGroupEl = document.querySelector(".checkbox-group");
const checkboxOriginalParent = checkboxGroupEl ? checkboxGroupEl.parentNode : null;
const infoSidePopupEl = document.getElementById("infoSidePopup");

// pastikan infoSidePopup menjadi child peta (agar terlihat di fullscreen)
const mapContainer = map.getContainer();
if (infoSidePopupEl && !mapContainer.contains(infoSidePopupEl)) {
  mapContainer.appendChild(infoSidePopupEl);
}

// simpan posisi awal checkbox (agar bisa dikembalikan setelah fullscreen)
const checkboxOriginalStyle = {
  position: checkboxGroupEl?.style.position,
  top: checkboxGroupEl?.style.top,
  right: checkboxGroupEl?.style.right,
  zIndex: checkboxGroupEl?.style.zIndex
};

// helper: pindah checkbox ke dalam container peta (agar muncul saat fullscreen)
function moveCheckboxIntoMap() {
  if (!checkboxGroupEl) return;
  if (!mapContainer.contains(checkboxGroupEl)) {
    mapContainer.appendChild(checkboxGroupEl);
  }
  checkboxGroupEl.style.position = "absolute";
  checkboxGroupEl.style.top = "100px";
  checkboxGroupEl.style.right = "20px";
  checkboxGroupEl.style.zIndex = 1001;
}

// helper: kembalikan checkbox ke parent aslinya
function moveCheckboxOutOfMap() {
  if (!checkboxGroupEl || !checkboxOriginalParent) return;
  if (!checkboxOriginalParent.contains(checkboxGroupEl)) {
    checkboxOriginalParent.appendChild(checkboxGroupEl);
  }
  // kembalikan gaya posisi ke semula
  checkboxGroupEl.style.position = checkboxOriginalStyle.position || "absolute";
  checkboxGroupEl.style.top = checkboxOriginalStyle.top || "20px";
  checkboxGroupEl.style.right = checkboxOriginalStyle.right || "20px";
  checkboxGroupEl.style.zIndex = checkboxOriginalStyle.zIndex || 1001;
}

// event dari leaflet.fullscreen: enterFullscreen / exitFullscreen
map.on && map.on('enterFullscreen', () => {
  moveCheckboxIntoMap();
  if (infoSidePopupEl && !mapContainer.contains(infoSidePopupEl)) {
    mapContainer.appendChild(infoSidePopupEl);
  }
});

map.on && map.on('exitFullscreen', () => {
  moveCheckboxOutOfMap();
});



  const csvURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRQ49PvuPoXJpEFiIt2nZ5lmQoiKB6TyVegg2tayy3uGTjNDtrsH3UgDdZCZ5IZoLiIrS3QAYDdJud/pub?gid=1559156266&single=true&output=csv";

  fetch(csvURL).then(r=>r.text()).then(t=>{
    const data=Papa.parse(t,{header:true}).data.filter(st=>st.LAT && st.LON);
    const tableBody = document.getElementById("tableBody");


    // === MARKER, LABEL, TABEL DATA (TETAP SAMA) ===
    data.forEach((st, idx) => {
  const lat = +st.LAT, lon = +st.LON;
  if (!lat || !lon) return;

  // === Tentukan kondisi per alat ===
  const kondisi = {
    theodolite: (() => {
      const baik = +st.TB || 0, ringan = +st.TR || 0, berat = +st.TRB || 0;
      if (baik > 0) return "baik";
      if (ringan > 0) return "rusak ringan";
      if (berat > 0) return "rusak berat";
      return "tidak ada";
    })(),
    tabung: (st.KTG || "").toLowerCase(),
    ground: (st.KR || "").toLowerCase(),
    kop: (st.KKG || "").toLowerCase(),
  };

  // === Fungsi bantu untuk pilih warna marker ===
  function warnaDariKondisi(k) {
    if (!k) return "#777";
    if (k.includes("baik")) return "green";
    if (k.includes("ringan")) return "#FFDE21";
    if (k.includes("berat")) return "red";
    return "#242424";
  }

  // === Buat marker untuk tiap alat ===
  const alatInfo = [
    {
      key: "theodolite",
      color: warnaDariKondisi(kondisi.theodolite),
      popup: `
        <b>${st.ID_Stasiun}</b><br><b>${st.Stasiun}</b><hr>
        <b>Theodolite:</b> ${kondisi.theodolite || "tidak ada data"}<br>
        ${st.DKT ? `<b>‚ÑπÔ∏è</b> ${st.DKT}<br>` : ""}
        ${st.kendala ? `<a href="#" class="kendala-link" data-text="${st.kendala.replace(/"/g,"&quot;")}">üö´ Kendala</a>` : ""}
      `,
    },
    {
      key: "tabung",
      color: warnaDariKondisi(kondisi.tabung),
      popup: `
        <b>${st.ID_Stasiun}</b><br><b>${st.Stasiun}</b><hr>
        <b>Tabung Gas:</b> ${st.KTG || "tidak ada data"}<br>
        ${st.JTG ? `<b>‚ÑπÔ∏è:</b> ${st.DKTG}<br>` : ""}
        ${st.DKTG ? `<b>Jenis:</b> ${st.JTG}<br>` : ""}
        ${st.kendala ? `<a href="#" class="kendala-link" data-text="${st.kendala.replace(/"/g,"&quot;")}">üö´ Kendala</a>` : ""}
      `,
    },
    {
      key: "ground",
      color: warnaDariKondisi(kondisi.ground),
      popup: `
        <b>${st.ID_Stasiun}</b><br><b>${st.Stasiun}</b><hr>
        <b>Ground Equipment:</b> ${st.KR || "tidak ada data"}<br>
        ${st.DKR ? `<b>‚ÑπÔ∏è:</b> ${st.DKR}<br>` : ""}
        ${st.kendala ? `<a href="#" class="kendala-link" data-text="${st.kendala.replace(/"/g,"&quot;")}">üö´ Kendala</a>` : ""}
      `,
    },
    {
      key: "kop",
      color: warnaDariKondisi(kondisi.kop),
      popup: `
        <b>${st.ID_Stasiun}</b><br><b>${st.Stasiun}</b><hr>
        <b>Kop Gas:</b> ${st.KKG || "tidak ada data"}<br>
        ${st.DKG ? `<b>‚ÑπÔ∏è:</b> ${st.DKG}<br>` : ""}
        ${st.kendala ? `<a href="#" class="kendala-link" data-text="${st.kendala.replace(/"/g,"&quot;")}">üö´ Kendala</a>` : ""}
      `,
    },
  ];

  // === Tambahkan marker ke tiap layer alat ===
alatInfo.forEach(info => {

  // ‚õîÔ∏è Jika ini layer ground, batasi hanya untuk baris 2‚Äì23 (idx mulai dari 0)
  if (info.key === "ground" && (idx < 1 || idx > 21)) return;

  const marker = L.circleMarker([lat, lon], {
    radius: 6,
    color: info.color,
    fillColor: info.color,
    fillOpacity: 0.85,
  }).bindPopup(info.popup);


    // Tooltip nama stasiun
    if (st.Label) {
      marker.bindTooltip(st.Label, {
        permanent: true,
        direction: "right",
        className: "station-label",
        interactive: true,
      });
    }

    marker.on("popupopen", e => {
      const el = e.popup.getElement();
      if (!el) return;
      L.DomEvent.disableClickPropagation(el);
      el.querySelectorAll(".info-link").forEach(link => {
        link.addEventListener("click", ev => {
          ev.preventDefault();
          showSidePopup(link.dataset.title, link.dataset.text);
        });
      });
      el.querySelectorAll(".kendala-link").forEach(link => {
        link.addEventListener("click", ev => {
          ev.preventDefault();
          showSidePopup("Kendala", link.dataset.text);
        });
      });
    });

    marker.on("tooltipclick", () => marker.openPopup());
    marker.addTo(alatLayers[info.key]);
  });

  // === Tambahkan baris ke tabel (tidak diubah) ===
  tableBody.insertAdjacentHTML("beforeend", `
    <tr>
      <td>${idx + 1}</td>
      <td>${st.Stasiun || ""}</td>
      <td>${st.TB || ""}</td>
      <td>${st.TR || ""}</td>
      <td>${st.TRB || ""}</td>
      <td>${st.DKT || ""}</td>
      <td>${st.KR || ""}</td>
      <td>${st.t_R || ""}</td>
      <td>${st.KTG || ""}</td>
      <td>${st.DKTG || ""}</td>
      <td>${st.t_TG || ""}</td>
      <td>${st.KKG || ""}</td>
      <td>${st.t_KG || ""}</td>
      <td>${st.kendala || ""}</td>
    </tr>
  `);
});


  function showSidePopup(title, text) {
  const box = document.getElementById("infoSidePopup");
  if (!box) return;

  box.innerHTML = `
    <b>${title}</b><hr>
    <div style="white-space: pre-wrap;">${text}</div>
    <hr>
    <button onclick="closeSidePopup()" style="
      width:100%;padding:5px;background:#0057b4;color:white;border:none;border-radius:5px;">OK</button>
  `;
  box.style.display = "block";

  // hitung posisi relatif ke container peta supaya bekerja baik di fullscreen
  const leafletPopup = document.querySelector(".leaflet-popup-content-wrapper");
  const mapRect = map.getContainer().getBoundingClientRect();

  // default posisi (kanan bawah relatif peta)
  let left = mapRect.width - box.offsetWidth - 20;
  let top = mapRect.height - box.offsetHeight - 20;

  if (leafletPopup) {
    const r = leafletPopup.getBoundingClientRect();
    // posisikan relatif ke peta: (r.right - mapRect.left) adalah koordinat kanan popup relatif peta
    left = (r.right - mapRect.left) + 15;
    top  = (r.top - mapRect.top);
    // pastikan tidak keluar dari area peta
    if (left + box.offsetWidth > mapRect.width - 10) left = mapRect.width - box.offsetWidth - 20;
    if (top + box.offsetHeight > mapRect.height - 10) top = mapRect.height - box.offsetHeight - 20;
    if (left < 10) left = 10;
    if (top < 10) top = 10;
  }

  // karena box sekarang di dalam container peta (position: absolute), atur left/top relatif peta
  box.style.left = `${left}px`;
  box.style.top  = `${top}px`;
}

  function closeSidePopup(){document.getElementById("infoSidePopup").style.display="none";}
  map.on("click",()=>closeSidePopup());
  map.on("popupopen",()=>closeSidePopup());

  var legend=L.control({position:"bottomleft"});
  legend.onAdd=function(map){
    var div=L.DomUtil.create("div","legend");
    const items=[
      {icon:"üü¢",label:"Baik"},
      {icon:"üü°",label:"Rusak Ringan"},
      {icon:"üî¥",label:"Rusak Berat"},
      {icon:"‚ö´",label:"Tidak ada data"}
    ];
    div.innerHTML="<b>Keterangan:</b><br>"+items.map(i=>`${i.icon} ${i.label}`).join("<br>");
    return div;
  };
  legend.addTo(map);

  // === Logika checkbox: hanya satu kategori alat yang bisa aktif ===
["theodolite", "tabung", "ground", "kop"].forEach(key => {
  const el = document.getElementById(key);
  el.addEventListener("change", e => {
    if (e.target.checked) {
      // Uncheck semua checkbox lain
      ["theodolite", "tabung", "ground", "kop"].forEach(otherKey => {
        if (otherKey !== key) {
          const otherEl = document.getElementById(otherKey);
          otherEl.checked = false;
          map.removeLayer(alatLayers[otherKey]);
        }
      });
      // Tampilkan layer yang dipilih
      map.addLayer(alatLayers[key]);
    } else {
      // Jika di-uncheck, layernya disembunyikan
      map.removeLayer(alatLayers[key]);
    }
  });
});

// === Set default ke "Theodolite" ===
document.getElementById("theodolite").checked = true;
map.addLayer(alatLayers["theodolite"]);
["tabung", "ground", "kop"].forEach(k => {
  document.getElementById(k).checked = false;
  map.removeLayer(alatLayers[k]);
});

});


  </script>
</body>
</html>







