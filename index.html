<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard OBA</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    .navbar { 
      position: fixed; top: 0; left: 0; right: 0;
      background: #000B58; color: #FDEB9E;
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 20px; z-index: 1000;
    }
    .navbar .links a { color:white; margin-right:15px; text-decoration:none; cursor:pointer; }
    .navbar .links a.active { font-weight:bold; text-decoration:underline; }
    .page { display:none; padding:10px; margin-top:55px; }
    .page.active { display:block; }
    #map { position: relative; height: 80vh; width: 100%; }
    .gform-link {
      position: fixed;
      top: 15px;
      right: 20px;
      background-color: #0057b4;
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background-color 0.2s;
      z-index: 1000;
    }
    .checkbox-group {
      position: absolute; top: 100px; right: 20px;
      background: white; padding: 8px; border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1001;
      font-size: 14px;
    }
    .station-label {
      font-size: 12px;
      color: #000;
      background: white;
      padding: 2px 6px;
      border: none;
      box-shadow: none;
    }
    table { border-collapse:collapse; width:100%; font-size:14px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th {
      background: #acdaff;
      position: sticky;
      top: 0;
      z-index: 2;
      box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }
    table td:nth-child(3) { text-align: left; padding-left: 8px; }
    .info-side-popup {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      padding: 10px;
      font-size: 13px;
      width: 250px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 10000;
      display: none;
      animation: slideIn 0.2s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .legend {
      background: white;
      padding: 8px 12px;
      font-size: 13px;
      line-height: 18px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .pengadaan-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }
    .pengadaan-table {
      width: 48%;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="links">
      <a id="linkMap" class="active">üåç Peta</a> 
      <a id="linkData">üìä Tabel Data</a>
      <a id="linkPengadaan">üì¶ Pengadaan</a>
      <a href="https://forms.gle/KjUSwAp6DjGzHYE86" target="_blank" class="gform-link">üìù Update Data Stasiun</a>
    </div>
  </div>

  <div id="pageMap" class="page active">
    <h3>Sebaran Kondisi Peralatan Pengamatan Udara Atas UPT</h3>
    <div id="map"></div>
    <div id="infoSidePopup" class="info-side-popup"></div>
  </div>

  <div class="checkbox-group">
    <label><input type="checkbox" id="balaiI" checked> Balai I </label><br>
    <label><input type="checkbox" id="balaiII" checked> Balai II </label><br>
    <label><input type="checkbox" id="balaiIII" checked> Balai III </label><br>
    <label><input type="checkbox" id="balaiIV" checked> Balai IV </label><br>
    <label><input type="checkbox" id="balaiV" checked> Balai V </label>
  </div>

  <div id="pageData" class="page">
    <h4>Tabel Data Peralatan Observasi Udara Atas UPT</h4>
    <div style="max-height: 70vh; overflow-y: auto; overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>No</th><th>Nomor Stasiun</th><th>Stasiun</th>
            <th>Theodolite Baik</th><th>Theodolite Rusak Ringan</th><th>Theodolite Rusak Berat</th>
            <th>Kerusakan Theodolite</th><th>Kondisi Receiver</th><th>Kondisi Tabung Gas</th>
            <th>Jenis Tabung Gas</th><th>Kerusakan Tabung Gas</th><th>Kendala Lainnya</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="pagePengadaan" class="page">
    <h3>üì¶ Daftar Stasiun Penerima Pengadaan Alat</h3>
    <div class="pengadaan-container">
      <div class="pengadaan-table">
        <h4>Pengadaan Tahun 2025</h4>
        <table>
          <thead><tr><th>Theodolite</th><th>Tabung Gas</th></tr></thead>
          <tbody id="pengadaan2025"></tbody>
        </table>
      </div>
      <div class="pengadaan-table">
        <h4>Pengadaan Tahun 2026</h4>
        <table>
          <thead><tr><th>Theodolite</th><th>Tabung Gas</th></tr></thead>
          <tbody id="pengadaan2026"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
  // === NAVIGATION ===
  const linkMap = document.getElementById("linkMap"),
        linkData = document.getElementById("linkData"),
        linkPengadaan = document.getElementById("linkPengadaan"),
        pageMap = document.getElementById("pageMap"),
        pageData = document.getElementById("pageData"),
        pagePengadaan = document.getElementById("pagePengadaan");

  function showPage(link, page) {
    [linkMap, linkData, linkPengadaan].forEach(l => l.classList.remove("active"));
    [pageMap, pageData, pagePengadaan].forEach(p => p.classList.remove("active"));
    link.classList.add("active");
    page.classList.add("active");
  }

  linkMap.onclick = () => showPage(linkMap, pageMap);
  linkData.onclick = () => showPage(linkData, pageData);
  linkPengadaan.onclick = () => showPage(linkPengadaan, pagePengadaan);

  // === kontrol visibilitas checkbox balai ===
function toggleCheckboxVisibility(show) {
  document.querySelectorAll(".checkbox-group").forEach(el => {
    el.style.display = show ? "block" : "none";
  });
}

// tampilkan hanya di page peta
linkMap.addEventListener("click", () => {
  toggleCheckboxVisibility(true);
});

linkData.addEventListener("click", () => {
  toggleCheckboxVisibility(false);
});

linkPengadaan.addEventListener("click", () => {
  toggleCheckboxVisibility(false);
});

  // === MAP SETUP ===
  const map = L.map("map", {
    fullscreenControl: true,
    fullscreenControlOptions: { position: 'topleft' }
  }).setView([-2.5,118],5);

  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: '&copy; Esri, HERE, Garmin, FAO, NOAA, USGS'
  }).addTo(map);

  const balaiLayers={I:L.layerGroup().addTo(map),II:L.layerGroup().addTo(map),
                     III:L.layerGroup().addTo(map),IV:L.layerGroup().addTo(map),
                     V:L.layerGroup().addTo(map)};
  
  // --- make popup & checkbox visible in fullscreen ---
// ambil elemen checkbox-group dan infoSidePopup
const checkboxGroupEl = document.querySelector(".checkbox-group");
const checkboxOriginalParent = checkboxGroupEl ? checkboxGroupEl.parentNode : null;
const infoSidePopupEl = document.getElementById("infoSidePopup");

// pastikan infoSidePopup menjadi child peta (agar terlihat di fullscreen)
const mapContainer = map.getContainer();
if (infoSidePopupEl && !mapContainer.contains(infoSidePopupEl)) {
  mapContainer.appendChild(infoSidePopupEl);
}

// simpan posisi awal checkbox (agar bisa dikembalikan setelah fullscreen)
const checkboxOriginalStyle = {
  position: checkboxGroupEl?.style.position,
  top: checkboxGroupEl?.style.top,
  right: checkboxGroupEl?.style.right,
  zIndex: checkboxGroupEl?.style.zIndex
};

// helper: pindah checkbox ke dalam container peta (agar muncul saat fullscreen)
function moveCheckboxIntoMap() {
  if (!checkboxGroupEl) return;
  if (!mapContainer.contains(checkboxGroupEl)) {
    mapContainer.appendChild(checkboxGroupEl);
  }
  checkboxGroupEl.style.position = "absolute";
  checkboxGroupEl.style.top = "100px";
  checkboxGroupEl.style.right = "20px";
  checkboxGroupEl.style.zIndex = 1001;
}

// helper: kembalikan checkbox ke parent aslinya
function moveCheckboxOutOfMap() {
  if (!checkboxGroupEl || !checkboxOriginalParent) return;
  if (!checkboxOriginalParent.contains(checkboxGroupEl)) {
    checkboxOriginalParent.appendChild(checkboxGroupEl);
  }
  // kembalikan gaya posisi ke semula
  checkboxGroupEl.style.position = checkboxOriginalStyle.position || "absolute";
  checkboxGroupEl.style.top = checkboxOriginalStyle.top || "20px";
  checkboxGroupEl.style.right = checkboxOriginalStyle.right || "20px";
  checkboxGroupEl.style.zIndex = checkboxOriginalStyle.zIndex || 1001;
}

// event dari leaflet.fullscreen: enterFullscreen / exitFullscreen
map.on && map.on('enterFullscreen', () => {
  moveCheckboxIntoMap();
  if (infoSidePopupEl && !mapContainer.contains(infoSidePopupEl)) {
    mapContainer.appendChild(infoSidePopupEl);
  }
});

map.on && map.on('exitFullscreen', () => {
  moveCheckboxOutOfMap();
});



  const csvURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRQ49PvuPoXJpEFiIt2nZ5lmQoiKB6TyVegg2tayy3uGTjNDtrsH3UgDdZCZ5IZoLiIrS3QAYDdJud/pub?gid=1559156266&single=true&output=csv";

  fetch(csvURL).then(r=>r.text()).then(t=>{
    const data=Papa.parse(t,{header:true}).data.filter(st=>st.LAT && st.LON);
    const tableBody = document.getElementById("tableBody");

    // === PENGADAAN 2025 & 2026 ===
    const pengadaan2025 = document.getElementById("pengadaan2025");
    const pengadaan2026 = document.getElementById("pengadaan2026");

    data.forEach(st=>{
      if(st.T25 || st.TG25){
        pengadaan2025.insertAdjacentHTML("beforeend",
          `<tr><td>${st.T25||""}</td><td>${st.TG25||""}</td></tr>`);
      }
      if(st.T26 || st.TG26){
        pengadaan2026.insertAdjacentHTML("beforeend",
          `<tr><td>${st.T26||""}</td><td>${st.TG26||""}</td></tr>`);
      }
    });

    // === MARKER, LABEL, TABEL DATA (TETAP SAMA) ===
    data.forEach((st, idx)=>{
      const lat=+st.LAT, lon=+st.LON, balai=(st.Balai||"I").trim();
      let html=`<b>${st.ID_Stasiun}</b><br><b>${st.Stasiun}</b><br><br>`;
      const tParts=[];

      if(st.TB && st.TB!=="0")tParts.push(`${st.TB}üü¢`);
      if(st.TR && st.TR!=="0")tParts.push(`${st.TR}üü°`);
      if(st.TRB && st.TRB!=="0")tParts.push(`${st.TRB}üî¥`);

      if(tParts.length>0){
        html+=`<b>Theodolite:</b> ${tParts.join(" ")} `;
        if(st.DKT && st.DKT.trim()!=="")
          html+=`<a href="#" class="info-link" data-title="Theodolite" data-text="${st.DKT.replace(/"/g,"&quot;")}">üí¨</a>`;
        html+=`<br>`;
      }

      if(st.KTG && st.KTG.trim()!==""){
        let icon="‚ùì"; const kt=st.KTG.toLowerCase();
        if(kt.includes("baik"))icon="üü¢";
        else if(kt.includes("berat"))icon="üî¥";
        else if(kt.includes("rusak"))icon="üü°";
        html+=`<b>Tabung Gas:</b> ${icon}`;
        const d=[st.JTG,st.DKTG].filter(Boolean).join("; ");
        if(d!=="")html+=` <a href="#" class="info-link" data-title="Tabung Gas" data-text="${d.replace(/"/g,"&quot;")}">üí¨</a>`;
        html+=`<br>`;
      }

      if(st.KR && st.KR.trim()!==""){
        let icon="‚ùì"; const kr=st.KR.toLowerCase();
        if(kr.includes("baik"))icon="üü©";
        else if(kr.includes("berat"))icon="üü•";
        else if(kr.includes("rusak ringan"))icon="üü®";
        html+=`<b>Receiver:</b> ${icon}`;
        if(st.DKR && st.DKR.trim()!==""){
          html+=` <a href="#" class="info-link" data-title="Receiver" data-text="${st.DKR.replace(/"/g,"&quot;")}">üí¨</a>`;
        }
        html+=`<br>`;
      }

      if(st.kendala && st.kendala.trim()!==""){
        html+=`<hr><a href="#" class="kendala-link" data-text="${st.kendala.replace(/"/g,"&quot;")}">üö´Kendala</a>`;
      }

      // === tentukan warna marker ===
let markerColor = "#000B58"; // default
const kondisiList = [
  st.TRB, st.DKT, st.KR, st.KTG, st.JTG, st.DKTG
].map(v => (v || "").toLowerCase());

if (kondisiList.some(k => k.includes("rusak berat"))) {
  markerColor = "red";
}

// === Marker + Tooltip ===
const marker = L.circleMarker([lat, lon], {
  radius: 6, color: markerColor, fillColor: markerColor, fillOpacity: 0.8
}).bindPopup(html);


      if (st.Label) {
  // cek isi kolom Pengamatan
  const pengamatan = (st["Pengamatan"] || "").toUpperCase();
  // kalau "PR" ‚Üí warna biru muda, kalau tidak biarkan default
  const labelColor = pengamatan === "PR" ? "blue" : "#000";

  marker.bindTooltip(st.Label, {
    permanent: true,
    direction: "top",
    className: "station-label",
    interactive: true,
  });

  // ubah warna teks label lewat DOM setelah tooltip dibuat
  marker.on("add", () => {
    const tooltipEl = marker.getTooltip()?.getElement();
    if (tooltipEl) tooltipEl.style.color = labelColor;
  });
}


      marker.on("tooltipclick",()=>marker.openPopup());
      marker.addTo(balaiLayers[balai]);

      marker.on("popupopen",e=>{
        const el=e.popup.getElement(); if(!el)return;
        L.DomEvent.disableClickPropagation(el);
        el.querySelectorAll(".info-link").forEach(link=>{
          link.addEventListener("click",ev=>{
            ev.preventDefault(); showSidePopup(link.dataset.title,link.dataset.text);
          });
        });
        el.querySelectorAll(".kendala-link").forEach(link=>{
          link.addEventListener("click",ev=>{
            ev.preventDefault(); showSidePopup("Kendala",link.dataset.text);
          });
        });
      });

      tableBody.insertAdjacentHTML("beforeend",`
        <tr>
          <td>${idx+1}</td>
          <td>${st.ID_Stasiun||""}</td>
          <td>${st.Stasiun||""}</td>
          <td>${st.TB||""}</td>
          <td>${st.TR||""}</td>
          <td>${st.TRB||""}</td>
          <td>${st.DKT||""}</td>
          <td>${st.KR||""}</td>
          <td>${st.KTG||""}</td>
          <td>${st.JTG||""}</td>
          <td>${st.DKTG||""}</td>
          <td>${st.kendala||""}</td>
        </tr>`);
    });
  });

  function showSidePopup(title, text) {
  const box = document.getElementById("infoSidePopup");
  if (!box) return;

  box.innerHTML = `
    <b>${title}</b><hr>
    <div style="white-space: pre-wrap;">${text}</div>
    <hr>
    <button onclick="closeSidePopup()" style="
      width:100%;padding:5px;background:#0057b4;color:white;border:none;border-radius:5px;">OK</button>
  `;
  box.style.display = "block";

  // hitung posisi relatif ke container peta supaya bekerja baik di fullscreen
  const leafletPopup = document.querySelector(".leaflet-popup-content-wrapper");
  const mapRect = map.getContainer().getBoundingClientRect();

  // default posisi (kanan bawah relatif peta)
  let left = mapRect.width - box.offsetWidth - 20;
  let top = mapRect.height - box.offsetHeight - 20;

  if (leafletPopup) {
    const r = leafletPopup.getBoundingClientRect();
    // posisikan relatif ke peta: (r.right - mapRect.left) adalah koordinat kanan popup relatif peta
    left = (r.right - mapRect.left) + 15;
    top  = (r.top - mapRect.top);
    // pastikan tidak keluar dari area peta
    if (left + box.offsetWidth > mapRect.width - 10) left = mapRect.width - box.offsetWidth - 20;
    if (top + box.offsetHeight > mapRect.height - 10) top = mapRect.height - box.offsetHeight - 20;
    if (left < 10) left = 10;
    if (top < 10) top = 10;
  }

  // karena box sekarang di dalam container peta (position: absolute), atur left/top relatif peta
  box.style.left = `${left}px`;
  box.style.top  = `${top}px`;
}

  function closeSidePopup(){document.getElementById("infoSidePopup").style.display="none";}
  map.on("click",()=>closeSidePopup());
  map.on("popupopen",()=>closeSidePopup());

  var legend=L.control({position:"bottomleft"});
  legend.onAdd=function(map){
    var div=L.DomUtil.create("div","legend");
    const items=[
      {icon:"üü¢",label:"Baik"},
      {icon:"üü°",label:"Rusak Ringan Bisa Digunakan"},
      {icon:"üî¥",label:"Rusak Berat"},
      {icon:"‚ùì",label:"Tidak ada data"}
    ];
    div.innerHTML="<b>Keterangan:</b><br>"+items.map(i=>`${i.icon} ${i.label}`).join("<br>");
    return div;
  };
  legend.addTo(map);

  ["I","II","III","IV","V"].forEach(b=>{
    const el=document.getElementById("balai"+b);
    el.onchange=e=>{
      e.target.checked?map.addLayer(balaiLayers[b]):map.removeLayer(balaiLayers[b]);
    };
  });
  </script>
</body>
</html>
